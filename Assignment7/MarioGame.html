<html>
    <head>
        <title>Mario in JavaScript!</title>
    </head>
    <body>
    <br>
    <canvas id = "myCanvas" width = "1000" height = "500" style = "border:1px solid #cccccc;"></canvas>
<script type = "text/javascript">
    class Sprite
    {
        constructor(x1, y1, w1, h1, image_url)
        {
            this.x = x1;
            this.y = y1;
            this.w = w1;
            this.h = h1;
            this.flip = false;
            this.image = new Image();
            this.image.src = image_url;
        }

        checkCollision(s)
        {
            if(this.x + this.w <= s.x)  //this right < sprite's left
                return false;
		    if(this.x >= s.x + s.w)  //this left > sprite's right
                return false;
            if(this.y >= s.y + s.h)  //this top underneath sprite base
                return false;
            if(this.y + this.h <= s.y)   //this base over sprite's top
                return false;
            //System.out.println("collison");
            return true;
        }

        isBrick(){return false;}
        isCoinBrick(){return false;}
    }


    class Brick extends Sprite
    {
        constructor(x, y, w, h, image_url)
        {
            super(x, y, w, h, image_url);
        }

        update(){} //no move

        isBrick(){return true;}

    }


    class CoinBrick extends Sprite
    {
        constructor(x, y, w, h, image_url)
        {
            super(x, y, w, h, image_url);
            this.coinCounter = 0;
        }
        
        update()
        {
            if(this.coinCounter >= 5)
                return false;
            else
                return true;
        }

        isCoinBrick(){return true;}
    
    }


    class Coin extends Sprite
    {
        constructor(x, y, w, h, image_url)
        {
            super(x, y, w, h, image_url);
            vert_vel = -10.0;
        }

        update()
        {
            y += vert_vel;
            x += (5);
            vert_vel += 1.2;

            if(this.y > 500)
                return false;
            else
                return true;
        }
    }


    class Mario extends Sprite
    {
        constructor(x, y, w, h, image_url)
        {
            super(x, y, w, h, image_url);
            this.flip = false;
            this.vert_vel = 0.0;

            this.py = 0;
            this.px = 0;

            this.images = [];
            this.images.push("mario1");
            this.images.push("mario2");
            this.images.push("mario3");
            this.images.push("mario4");
            this.images.push("mario5");

        }

        update()
        {
            if(this.vert_vel != 0.0) //if not standing on ground or brick start counting frames
            {
                this.frameCounter++;
            }
            else    //once landed set frames back to zero
            {
                this.frameCounter = 0;
            }

            this.savePrevY()
            this.vert_vel += 1.2;
            this.y += this.vert_vel;

            if(this.y > 400)
            {
                this.vert_vel = 0.0;
                this.y = 400; // snap back to the ground
            }

            return true;
        }

        getOutOfTheObstacle(s)
        {
            if(this.x + this.w > s.x && this.px + this.w <= s.x) //collision with left side of brick
                    this.x = s.x - this.w;
            if(this.x < s.x + s.w && this.px >= s.x + s.w) //collision with right side of brick     
                    this.x = s.x + s.w;

            if(this.y + this.h >= s.y && this.py + this.h <= s.y)   //collision with top of brick
                {
                    this.y = s.y - this.h;
                    this.vert_vel = 0.0;
                }
            if(this.y <= s.y + s.h && this.py >= s.y + s.h) //collision with bottom of brick
                {
                    this.y = s.y + s.h + 1;
                    this.frameCounter = 6;
                    this.vert_vel = 0.1;
                    if(s.isCoinBrick())
                    {
                        return true;  
                    }
                }
        return false;
        }

        savePrevX()
        {
            this.px = this.x;
        }
        
        savePrevY()
        {
            this.py = this.y;
        }

        updateImageNum()
        {
            let imageNum = 0;
            
            this.imageNum++;
            if(this.imageNum > 4)
                imageNum = 0;
            

        }
    }


    class Model
    {
        constructor()
        {
            this.sprites = [];
            this.brick = new Brick(50, 50, 50, 50, "brick.png");
            this.sprites.push(this.brick);
            this.brick1 = new Brick(100, 100, 50, 50, "brick.png");
            this.sprites.push(this.brick1);
            this.brick2 = new Brick(200, 200, 50, 50, "brick.png");
            this.sprites.push(this.brick2);
            this.brick3 = new Brick(250, 300, 50, 50, "brick.png");
            this.sprites.push(this.brick3);
            this.brick4 = new Brick(400, 450, 50, 50, "brick.png");
            this.sprites.push(this.brick4);
            this.coinBrick = new CoinBrick(500, 300, 50, 50, "coinBrick.png");
            this.sprites.push(this.coinBrick);
            this.mario = new Mario(10, 300, 60, 95, "mario1.png");
            this.sprites.push(this.mario);

        }

        update()
        {
            for(let i = 0; i < this.sprites.length; i++)
            {
                this.sprites[i].update();

                if(this.sprites[i].isBrick() || this.sprites[i].isCoinBrick())
                {
                    if(this.mario.checkCollision(this.sprites[i]))
                    {
                        if(this.mario.getOutOfTheObstacle(this.sprites[i]))
                        {
                            console.log("frank0");
                        }
                    }
                }
            }
        }
    }


    class View
    {
        constructor(model)
        {
            this.model = model;
            this.canvas = document.getElementById("myCanvas");
            // this.mario = new Image();
            // this.mario.src = "mario1.png";
            // this.brick = new Image();
            // this.brick.src = "brick.png";

        }

        update()
        {
            let ctx = this.canvas.getContext("2d");
            ctx.clearRect(0, 0, 1000, 500);
            for(let i = 0; i <this.model.sprites.length; i++)
            {
                let sprite = this.model.sprites[i];
            if(sprite.flip)
            {
                ctx.save();
                ctx.translate(sprite.x + sprite.w, 0);
                ctx.scale(-1,1);
                ctx.drawImage(sprite.image, 0, sprite.y, sprite.w, sprite.h);
                ctx.restore();
            }
            else
                ctx.drawImage(sprite.image, sprite.x, sprite.y, sprite.w, sprite.h);
            }
        }
    }


    class Game
    {
        constructor()
        {
            this.model = new Model();
            this.view = new View(this.model);
            this.controller = new Controller(this.model, this.view);
        }

        onTimer()
        {
            this.controller.update();
            this.model.update();
            this.view.update();
        }
    }


    class Controller
    {
        constructor(model, view)
        {
            this.model = model;
            this.view = view;
            this.key_right = false;
            this.key_left = false;
            this.key_up = false;
            this.key_down = false;
            let self = this;
            document.addEventListener('keydown', function(event) { self.keyPressed(event);}, false);
            document.addEventListener('keyup', function(event) { self.keyReleased(event);}, false);
        }

        keyPressed(event)
        {
            if(event.keyCode == 39) this.key_right = true;
            else if(event.keyCode == 37) this.key_left = true;
            else if(event.keyCode == 38) this.key_up = true;
            else if(event.keyCode == 40) this.key_down = true;
        }

        keyReleased(event)
        {
            if(event.keyCode == 39) this.key_right = false;
            else if(event.keyCode == 37) this.key_left = false;
            else if(event.keyCode == 38) this.key_up = false;
            else if(event.keyCode == 40) this.key_down = false;
        }

        update()
        {
            this.model.mario.savePrevX()
            if(this.key_right)
            {
                this.model.mario.flip = false;
                this.model.mario.x += 5;
                // this.view.backgroundLocation += 2;
                this.model.mario.updateImageNum();
            }
            if(this.key_left)
            {
                this.model.mario.flip = true;
                this.model.mario.x -= 5;
                this.model.mario.updateImageNum();
                // view.backgroundLocation -= 2;
            }
            //if(keyDown);
            if(this.key_up)
            {
                this.model.mario.y-=2;
                if(this.model.mario.frameCounter < 5)
                    this.model.mario.vert_vel -= 5.3;
            } 
            }
    }

let game = new Game();
let timer = setInterval(function() {game.onTimer()}, 30);

</script>

</body>

    
</html>